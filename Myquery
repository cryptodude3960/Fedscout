import requests
import os
import json
from datetime import datetime, timedelta

class FederalContractingClient:
    def __init__(self, client_name):
        self.client_name = client_name
        self.client_data = {
            "registration_status": "Unknown",
            "capability_statement": "Not Reviewed",
            "past_performance": [],
            "compliance": "Unknown",
            "current_opportunities": [],
            "next_steps": []
        }
    
    def update_status(self, key, value):
        if key in self.client_data:
            self.client_data[key] = value
        else:
            print(f"Invalid key: {key}")
    
    def add_past_performance(self, contract_details):
        self.client_data["past_performance"].append(contract_details)
    
    def add_opportunity(self, opportunity_details):
        self.client_data["current_opportunities"].append(opportunity_details)
    
    def add_next_step(self, step):
        self.client_data["next_steps"].append(step)
    
    def display_summary(self):
        print(f"\nFederal Contracting Summary for {self.client_name}")
        for key, value in self.client_data.items():
            print(f"{key.replace('_', ' ').title()}: {value}")

class FederalContractingTool:
    def __init__(self, storage_file="contracting_clients.json"):
        self.clients = {}
        self.api_key = os.getenv("SAM_GOV_API_KEY", "yfztBk00vlrpghK7wf84zDGKUnNtPPfiB3IgvFU6")
        self.storage_file = storage_file
        self.load_clients()
    
    def add_client(self, client_name):
        if client_name not in self.clients:
            self.clients[client_name] = FederalContractingClient(client_name)
            self.save_clients()
        else:
            print(f"Client {client_name} already exists.")
    
    def get_client(self, client_name):
        return self.clients.get(client_name, None)
    
    def list_clients(self):
        return list(self.clients.keys())
    
    def display_all_clients(self):
        for client_name in self.clients:
            self.clients[client_name].display_summary()
    
    def save_clients(self):
        with open(self.storage_file, "w") as f:
            json.dump({name: client.client_data for name, client in self.clients.items()}, f, indent=4)
    
    def load_clients(self):
        if os.path.exists(self.storage_file):
            with open(self.storage_file, "r") as f:
                data = json.load(f)
                for name, client_data in data.items():
                    client = FederalContractingClient(name)
                    client.client_data = client_data
                    self.clients[name] = client
    
    def fetch_sam_gov_opportunities(self, naics_code):
        base_url = "https://api.sam.gov/prod/opportunities/v2/search"
        today = datetime.today().strftime('%m/%d/%Y')
        past_30_days = (datetime.today() - timedelta(days=30)).strftime('%m/%d/%Y')

        params = {
            "api_key": self.api_key,
            "filters": f"naicsCode:{naics_code}",
            "limit": 10,
            "postedFrom": past_30_days,
            "postedTo": today
        }
        headers = {"Accept": "application/json"}

        try:
            response = requests.get(base_url, params=params, headers=headers)
            if response.status_code == 429:
                print("Rate limit exceeded. Please wait and try again later.")
                return []
            
            response.raise_for_status()
            
            data = response.json()
            opportunities = data.get("opportunitiesData", [])
            
            if not opportunities:
                print(f"No current opportunities found for NAICS {naics_code}")
                return []
            
            return opportunities
        
        except requests.exceptions.HTTPError as http_err:
            print(f"HTTP error: {http_err} - {response.text}")
        except requests.exceptions.RequestException as req_err:
            print(f"Request error: {req_err}")
        except Exception as e:
            print(f"Unexpected error: {e}")

        return []
    
    def update_client_opportunities(self, client_name, naics_code):
        client = self.get_client(client_name)
        if client:
            opportunities = self.fetch_sam_gov_opportunities(naics_code)
            for opportunity in opportunities:
                client.add_opportunity(opportunity.get("title", "No Title Available"))
            self.save_clients()
        else:
            print(f"Client {client_name} not found.")

# Example Usage
if __name__ == "__main__":
    tool = FederalContractingTool()
    tool.add_client("Crown Jewels Produce")
    client = tool.get_client("Crown Jewels Produce")
    if client:
        client.update_status("registration_status", "SAM.gov Registered")
        client.update_status("capability_statement", "Needs Improvement")
        client.add_past_performance("DLA Troop Support - Fresh Produce Supply Contract")
        tool.update_client_opportunities("Crown Jewels Produce", "424480")
        client.add_next_step("Finalize Capability Statement with Past Performance Details")
        client.display_summary()

    tool.add_client("ABC Logistics")
    print("\nAll Clients:", tool.list_clients())
    tool.display_all_clients()
